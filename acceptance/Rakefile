$:.unshift(File.join(File.dirname(__FILE__), "..", "lib"))

require 'fileutils'

require 'ciat'
require 'ciat/compilers/java'
require 'ciat/compilers/copy'
require 'ciat/executors/cat'
require 'ciat/executors/parrot'

desc "Cleans the output directory, compiles the Java code, runs tests"
task :default => [:clean_start, :compile_java,
                  :simple, :java_cat, :java_parrot, :failures] do
  check_output_files
end

task :compile_java do
  unless system("cd java ; javac *.java")
    raise Exception.new
  end
end

task :clean_start do
  FileUtils.rm_r("temp/") if File.exists?("temp/")
end

task :simple do
  puts "Copy compiler, cat executor"
  CIAT::Suite.new(copy_compiler, cat_executor,
    :files => ['ciat/copy-cat.ciat'],
    :feedback => FeedbackTester.new(1)).run
end
  
task :java_cat do
  puts "Java compiler, cat executor, TWO tests, special folder"
  CIAT::Suite.new(java_compiler("Hello"), cat_executor,
    :folder => 'ciat/java-cat',
    :report_filename => 'java-cat.html',
    :feedback => FeedbackTester.new(2)).run
end

task :java_parrot do
  puts "Java compiler, Parrot executor, special folder"
  CIAT::Suite.new(java_compiler("Parrot5"), parrot_executor,
    :folder => 'ciat/java-parrot',
    :report_filename => 'java-parrot.html',
    :feedback => FeedbackTester.new(1)).run  
end

task :failures do
  puts "Error during compilation"
  CIAT::Suite.new(java_compiler("Erroring"), ExceptionalExecutor.new,
    :files => 'ciat/failures/compile-error.ciat',
    :report_filename => 'compile-error.html',
    :feedback => FeedbackTester.new(1)).run
  puts "Compilation fails expectation"
  CIAT::Suite.new(copy_compiler, ExceptionalExecutor.new,
    :files => 'ciat/failures/compile-fail.ciat',
    :report_filename => 'compile-fail.html',
    :feedback => FeedbackTester.new(1)).run
  puts "Error during execution"
  CIAT::Suite.new(copy_compiler, ErroringExecutor.new,
    :files => 'ciat/failures/execution-error.ciat',
    :report_filename => 'execution-error.html',
    :feedback => FeedbackTester.new(1)).run
  puts "Execution fails expectation"
  CIAT::Suite.new(copy_compiler, cat_executor,
    :files => 'ciat/failures/execution-fail.ciat',
    :report_filename => 'execution-fail.html',
    :feedback => FeedbackTester.new(1)).run
end

#
# Compilers & Executors
#
def copy_compiler
  CIAT::Compilers::Copy.new
end

def java_compiler(type)
  CIAT::Compilers::Java.new('./java', type + 'Compiler')
end

def cat_executor
  CIAT::Executors::Cat.new
end

def parrot_executor
  CIAT::Executors::Parrot.new
end

class ExceptionalExecutor
  def execute(x,y)
    raise("**** should not run this executor!!!")
  end
end

class ErroringExecutor
  def execute(x, output_file)
    system("echo this should be the error output > #{output_file}")
    false
  end
end

#
# Output file checking
#
def check_output_files
  puts "Checking output files."
  Dir["**/*.html"].each do |file|
    system "tidy -mq #{file}"
  end
  unless system("diff -r temp_expected/ temp/")
    raise("**** diff failed!")
  end
end

#
# Feedback from running suite
#
class FeedbackTester
  def initialize(size)
    @size = size
  end
  
  def post_tests(suite)
    raise "Wrong number of tests: #{@size} expected, got #{suite.size}" unless suite.size == @size
  end
end
