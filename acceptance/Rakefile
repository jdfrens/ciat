$:.unshift(File.join(File.dirname(__FILE__), "..", "lib"))

require 'fileutils'

require 'ciat'
require 'ciat/compilers/java'
require 'ciat/processors/copy'
require 'ciat/executors/parrot'
require 'ciat/feedback/composite'

require 'do_not_process_executor'
require 'do_nothing_processor'
require 'feedback_tester'
require 'blowup_feedback'
require 'helpers'

desc "Cleans the output directory, compiles the Java code, runs tests"
task :default => [:clean_start, :compile_java,
                  :simple,
                  :java_cat, :java_parrot,
                  :failures,
                  :optional_elements] do
  check_output_files
end

task :compile_java do
  unless system("cd java ; javac *.java")
    raise "Java files failed to compile!"
  end
end

task :clean_start do
  FileUtils.rm_r("temp/") if File.exists?("temp/")
end

task :simple do
  puts "Should copy the source as a compilation"
  CIAT::Suite.new(
    :processors => [copy_compiler],
    :files => ['ciat/copy-cat.ciat'],
    :feedback => feedback(1, [:green])).run
end
    
task :java_cat do
  puts "Java compiler, copy executor, TWO tests, special folder"
  CIAT::Suite.new(
    :processors => [java_compiler("Hello"), copy_executor],
    :folder => 'ciat/java-cat',
    :report_filename => 'java-cat.html',
    :feedback => feedback(2, [:green, :green, :green, :green])).run
end

task :java_parrot do
  puts "Java compiler, Parrot executor, special folder"
  CIAT::Suite.new(
    :processors => [java_compiler("Parrot5"), parrot_executor],
    :folder => 'ciat/java-parrot',
    :report_filename => 'java-parrot.html',
    :feedback => feedback(1, [:green, :green])).run  
end

task :failures do
  puts "Should error during compilation"
  CIAT::Suite.new(
    :processors => [DoNothingProcessor.new(:yellow), DoNotProcessExecutor.new],
    :files => 'ciat/failures/compile-error.ciat',
    :report_filename => 'compile-error.html',
    :feedback => feedback(1, [:yellow, :unset])).run
  puts "Should fail compilation expectation"
  CIAT::Suite.new(
    :processors => [DoNothingProcessor.new(:red), DoNotProcessExecutor.new],
    :files => 'ciat/failures/compile-fail.ciat',
    :report_filename => 'compile-fail.html',
    :feedback => feedback(1, [:red, :unset])).run
  puts "Should error during execution"
  CIAT::Suite.new(
    :processors => [copy_compiler, DoNothingProcessor.new(:yellow)],
    :files => 'ciat/failures/execution-error.ciat',
    :report_filename => 'execution-error.html',
    :feedback => feedback(1, [:green, :yellow])).run
  puts "Should fails execution expectation"
  CIAT::Suite.new(
    :processors => [copy_compiler, DoNothingProcessor.new(:red)],
    :files => 'ciat/failures/execution-fail.ciat',
    :report_filename => 'execution-fail.html',
    :feedback => feedback(1, [:green, :red])).run
end

task :optional_elements do
  puts "Should allow optional 'command line' element with PIR virtual machine"
  CIAT::Suite.new(
    :processors => [parrot_executor],
    :folder => 'ciat/optional-elements',
    :report_filename => 'optional-elements.html',
    :feedback => feedback(1, [:green])).run
end

