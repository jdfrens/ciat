$:.unshift(File.join(File.dirname(__FILE__), "..", "lib")).
  unshift(File.join(File.dirname(__FILE__), "lib"))

require 'spec/rake/spectask'
require 'fileutils'

require 'ciat'
require 'ciat/processors/java'
require 'ciat/processors/parrot'
require 'ciat/feedback/composite'

require 'feedback_tester'
require 'helpers'

desc "Cleans the output directory, compiles the Java code, runs tests"
task :default => :acceptance

Spec::Rake::SpecTask.new(:acceptance_spec)
task :acceptance => [:full_exercise, :acceptance_spec]

task :full_exercise => [:clean_start, :compile_java,
                        :exercise_ciat,
                        :java,
                        :parrot,
                        :exercise_java_and_parrot]
                        
task :view do
  sh "open #{Dir["temp/*.html"].join(" ")}"
end

task :compile_java do
  unless system("cd java ; javac *.java")
    raise "Java files failed to compile!"
  end
end

task :clean_start do
  FileUtils.rm_r("temp/") if File.exists?("temp/")
end

# *************************************************************
# tasks to exercise CIAT itself
task :exercise_ciat => [:less_simple,
                        :subfolders,
                        :errors_and_failures]
    
CIAT::RakeTask.new(:less_simple) do |task|
  task.processors << java_compiler("Hello")
  task.folder = 'ciat/less-simple'
  task.feedback = feedback([:green, :green],
                    :report_filename => 'less-simple.html',
                    :report_title => 'Less Simple Tests')
end

CIAT::RakeTask.new(:subfolders) do |task|
  task.processors << java_compiler("Hello")
  task.folder = 'ciat/subfolders'
  task.feedback = feedback([:green, :green, :green],
                    :report_filename => 'subfolders.html',
                    :report_title => "Subfolder Tests")
end
    
task :errors_and_failures do
  deliberate_failure(RuntimeError, "CIAT tests unsuccessful") do
    suite = CIAT::Suite.build(
      :processors => [java_compiler("Hello"), java_interpreter("Hello")],
      :files => 'ciat/errors-and-failures/compile-error.ciat',
      :feedback => feedback([[:yellow, :unset]],
                    :report_filename => 'compile-error.html',
                    :report_title => "Errors during compilation")
      )
    suite.run
  end
  
  deliberate_failure(RuntimeError, "CIAT tests unsuccessful") do
    suite = CIAT::Suite.build(
      :processors => [java_compiler("Hello"), java_interpreter("Hello")],
      :files => 'ciat/errors-and-failures/compile-fail.ciat',
      :feedback => feedback([[:red, :unset]],
                    :report_filename => 'compile-fail.html',
                    :report_title => "Failures in compilation")
      )
    suite.run
  end
  
  deliberate_failure(RuntimeError, "CIAT tests unsuccessful") do
    suite = CIAT::Suite.build(
      :processors => [java_compiler("Hello"), java_interpreter("Hello")],
      :files => 'ciat/errors-and-failures/execution-error.ciat',
      :feedback => feedback([[:green, :yellow]],
                    :report_filename => 'execution-error.html',
                    :report_title => "Errors during execution")
      )
    suite.run
  end
  
  deliberate_failure(RuntimeError, "CIAT tests unsuccessful") do
    suite = CIAT::Suite.build(
      :processors => [java_compiler("Hello"), java_interpreter("Hello")],
      :files => 'ciat/errors-and-failures/execution-fail.ciat',
      :feedback => feedback([[:green, :red]],
                    :report_filename => 'execution-fail.html',
                    :report_title => "Failures in execution")
      )
    suite.run
  end
  
  deliberate_failure(IOError, "no test files specified") do
    suite = CIAT::Suite.build(
      :processors => [java_compiler("Hello")],
      :folder => 'ciat/folder-does-not-exist',
      :feedback => feedback([],
                    :report_filename => 'folder-does-not-exist.html',
                    :report_title => "Input Folder Doesn't Exist")
      )
    suite.run
  end
end

# *************************************************************
# exercise java processors
desc "exercise all of the Java permutations"
task :java => [:compile_java, "java:compiler", "java:interpreter"]

namespace :java do
  desc "exercise the in-Java compiler variations"
  task :compiler => ["java:compiler:success", "java:compiler:error", "java:compiler:failure"]
  
  namespace :compiler do
    desc "exercise success cases of an in-Java compiler"
    CIAT::RakeTask.new(:success) do |task|
      task.processors << java_compiler("Hello")
      task.folder = 'ciat/java/compiler/success'
      task.feedback = feedback([:green, :green],
        :report_filename => 'java-compiler-success.html')
    end
    
    desc "exercise error cases of an in-Java compiler"
    task :error do
      deliberate_failure(RuntimeError, "CIAT tests unsuccessful") do
        suite = CIAT::Suite.build(
          :processors => [java_compiler("Hello")],
          :folder => 'ciat/java/compiler/error',
          :feedback => feedback([:yellow],
            :report_filename => 'java-compiler-error.html')
          )
        suite.run
      end
    end
    
    desc "exercise failure cases of an in-Java compiler"
    task :failure do
      deliberate_failure(RuntimeError, "CIAT tests unsuccessful") do
        suite = CIAT::Suite.build(
          :processors => [java_compiler("Hello")],
          :folder => 'ciat/java/compiler/failure',
          :feedback => feedback([:red],
            :report_filename => 'java-compiler-failure.html')
          )
        suite.run
      end
    end
  end
  
  desc "exercise the in-Java interpreter variations"
  task :interpreter => ["java:interpreter:success", "java:interpreter:error", "java:interpreter:failure"]
  
  namespace :interpreter do
    desc "exercise success cases of an in-Java interpreter"
    CIAT::RakeTask.new(:success) do |task|
      task.processors << java_interpreter("Hello")
      task.folder = 'ciat/java/interpreter/success'
      task.feedback = feedback([:green, :green],
        :report_filename => 'java-interpreter-success.html')
    end
    
    desc "exercise error cases of an in-Java interpreter"
    task :error do
      deliberate_failure(RuntimeError, "CIAT tests unsuccessful") do
        suite = CIAT::Suite.build(
          :processors => [java_interpreter("Hello")],
          :folder => 'ciat/java/interpreter/error',
          :feedback => feedback([:yellow, :yellow],
            :report_filename => 'java-interpreter-error.html')
          )
        suite.run
      end
    end
    
    desc "exercise failure cases of an in-Java interpreter"
    task :failure do
      deliberate_failure(RuntimeError, "CIAT tests unsuccessful") do
        suite = CIAT::Suite.build(
          :processors => [java_interpreter("Hello")],
          :folder => 'ciat/java/interpreter/failure',
          :feedback => feedback([:red, :red],
            :report_filename => 'java-interpreter-failure.html')
          )
        suite.run
      end
    end
  end
end

# *************************************************************
desc "task to exercise Parrot interpreter"
task :parrot => ["parrot:success", "parrot:error", "parrot:failure"]

namespace :parrot do
  desc "exercise the success cases of the Parrot VM"
  CIAT::RakeTask.new(:success) do |task|
    task.processors << parrot_executor(interpreter)
    task.folder = 'ciat/parrot/success'
    task.feedback = feedback([:green, :green],
      :report_filename => 'parrot-success.html')
  end

  desc "exercise the error cases of the Parrot VM"
  task :error do
    deliberate_failure(RuntimeError, "CIAT tests unsuccessful") do
      suite = CIAT::Suite.build(
        :processors => [parrot_executor(interpreter)],
        :folder => 'ciat/parrot/error',
        :feedback => feedback([:yellow], :report_filename => 'parrot-error.html')
        )
      suite.run
    end
  end

  desc "exercise the failure cases of the Parrot VM"
  task :failure do
    deliberate_failure(RuntimeError, "CIAT tests unsuccessful") do
      suite = CIAT::Suite.build(
        :processors => [parrot_executor(interpreter)],
        :folder => 'ciat/parrot/failure',
        :feedback => feedback([:red], :report_filename => 'parrot-failure.html')  
        )
      suite.run
    end
  end
end

# *************************************************************
# task to exercise Java compiler and Parrot executor
CIAT::RakeTask.new(:exercise_java_and_parrot) do |task|
  task.processors << java_compiler("Parrot5")
  task.processors << parrot_executor(compilation_interpreter)
  task.folder = 'ciat/java-parrot'
  task.feedback = feedback([[:green, :green]],
                    :report_filename => 'java-parrot.html')
end
